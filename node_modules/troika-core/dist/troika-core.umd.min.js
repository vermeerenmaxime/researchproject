'use strict';(function(q,v){"object"===typeof exports&&"undefined"!==typeof module?v(exports,require("troika-animation"),require("react"),require("prop-types")):"function"===typeof define&&define.amd?define(["exports","troika-animation","react","prop-types"],v):(q="undefined"!==typeof globalThis?globalThis:q||self,v(q.troika_core={},q.troika_animation,q.React,q.PropTypes))})(this,function(q,v,t,x){function I(a){return a&&"object"===typeof a&&"default"in a?a:{"default":a}}function J(){let a=arguments[0];
for(let b=1,c=arguments.length;b<c;b++){let d=arguments[b];if(d)for(let b in d)d.hasOwnProperty(b)&&(a[b]=d[b])}return a}function K(){let a=arguments[0];for(let b=1,c=arguments.length;b<c;b++){let d=arguments[b];if(d)for(let b in d)d.hasOwnProperty(b)&&!a.hasOwnProperty(b)&&(a[b]=d[b])}return a}function L(a,b){if(b)for(let c in b)b.hasOwnProperty(c)&&(a[c]&&"object"===typeof a[c]&&"object"===typeof b[c]?L(a[c],b[c]):a[c]=b[c])}function B(a,b){let c=new WeakMap;return function(a){let d=c.get(a);d||
(d=b(a),c.set(a,d));return d}}function M(a){return(a=a.$$typeof)&&a.toString&&"Symbol(react.element)"===a.toString()||!1}function Y(a,b){return"paused"===a?void 0:Infinity===b?"Infinity":b}function Z(a,b){return a.time-b.time}function C(a){return"onDoubleClick"===a?"dblclick":a.replace(/^on/,"").toLowerCase()}function aa(){function a(a,b,e,f){try{a.call(b,e,f)}catch(l){console.error(l)}}let b=Object.create(null);this.addListenerForFacade=(a,d,e)=>{d=b[d]||(b[d]={count:0,byFacadeId:Object.create(null)});
a=a.$facadeId;let c=d.byFacadeId[a];c?Array.isArray(c)?-1===c.indexOf(e)&&(d.count++,c.push(e)):c!==e&&(d.count++,d.byFacadeId[a]=[c,e]):(d.count++,d.byFacadeId[a]=e)};this.removeListenerForFacade=(a,d,e)=>{d=b[d];a=a.$facadeId;let c=d&&d.byFacadeId[a];c===e?(d.count--,delete d.byFacadeId[a]):Array.isArray(c)&&(e=c.indexOf(e),-1<e&&(d.count--,1===c.length?delete d.byFacadeId[a]:c.splice(e,1)))};this.removeAllListenersForFacade=a=>{a=a.$facadeId;for(let d in b){let c=b[d].byFacadeId[a];c&&(b[d].count-=
Array.isArray(c)?c.length:1,delete b[d].byFacadeId[a])}};this.hasFacadeListenersOfType=(a,d)=>b[d]?!!b[d].byFacadeId[a.$facadeId]:!1;this.hasAnyListenersOfType=a=>b[a]?0<b[a].count:!1;this.findBubblingEventTarget=(a,b)=>{for(;a;){if(this.hasFacadeListenersOfType(a,b))return a;a=a.parent}return null};this.forEachFacadeListenerOfType=(c,d,e,f)=>{d=b[d];c=c.$facadeId;if(d=d&&d.byFacadeId[c])if(Array.isArray(d))for(let b=0;b<d.length;b++)a(e,f,d[b],c);else a(e,f,d,c)};this.forEachListenerOfType=(c,d,
e)=>{if((c=b[c])&&0<c.count)for(let b in c.byFacadeId){let f=c.byFacadeId[b];if(Array.isArray(f))for(let c=0;c<f.length;c++)a(d,e,f[c],b);else a(d,e,f,b)}};this.dispatchEventOnFacade=(a,b)=>{function d(a){a.call(c,b)}let c=a;for(b.target=a;c&&!b.propagationStopped;)if(b.currentTarget=c,this.forEachFacadeListenerOfType(c,b.type,d,null),b.bubbles)c=c.parent;else break}}function D(a){return"touchend"===a.type||"touchcancel"===a.type}function ba(a){a.stopPropagation();a.preventDefault()}var r=I(t);t=
I(x);let w=Object.assign||J;x=(()=>{let a=new WeakMap,b=0;return function(c){let d=a.get(c);d||a.set(c,d=`$id${++b}`);return d}})();x=Object.freeze({__proto__:null,assign:w,_assign:J,assignIf:K,assignDeep:L,forOwn:function(a,b,c){for(let d in a)a.hasOwnProperty(d)&&b.call(c,a[d],d,a)},getIdForObject:x,memoize:function(a){let b,c,d;return function(){let e=!b||this!==c||arguments.length!==b.length;if(!e)for(let a=0,d=arguments.length;a<d;a++)if(arguments[a]!==b[a]){e=!0;break}e&&(b=Array.prototype.slice.call(arguments),
c=this,d=a.apply(this,arguments));return d}},createClassExtender:B,isReactElement:M});class u{constructor(a){this.$facadeId=`facade${ca++}`;this.parent=a}update(a){if(a&&"object"===typeof a){this.transition=a.transition;this.animation=a.animation;for(let b in a)a.hasOwnProperty(b)&&!u.isSpecialDescriptorProperty(b)&&(this[b]=a[b])}this.afterUpdate();this.requestRender()}afterUpdate(){let a=this.ref;a!==this._lastRef&&("function"===typeof this._lastRef&&this._lastRef.call(null,null),"function"===typeof a?
(a.call(null,this),this._lastRef=a):this._lastRef=null)}notifyWorld(a,b){if(this.parent)this.parent.onNotifyWorld(this,a,b)}onNotifyWorld(a,b,c){let d=this._notifiableParent;if(d)d.onNotifyWorld.call(d,a,b,c);else{d=this.parent;let e=u.prototype.onNotifyWorld;for(;d;){if(d.onNotifyWorld!==e){this._notifiableParent=d;d.onNotifyWorld(a,b,c);break}d=d.parent}}}requestRender(){this.notifyWorld("needsRender")}traverse(a){a(this)}forEachChild(a){}addEventListener(a,b){this.notifyWorld("addEventListener",
{type:a,handler:b})}removeEventListener(a,b){this.notifyWorld("removeEventListener",{type:a,handler:b})}dispatchEvent(a){this.notifyWorld("dispatchEvent",a)}destructor(){this.parent&&this.notifyWorld("removeAllEventListeners");"function"===typeof this.ref&&this.ref.call(null,null);this.parent=this._notifiableParent=null}}w(u.prototype,{ref:null,_lastRef:null,_notifiableParent:null});let ca=0,da={key:1,facade:1,transition:1,animation:1};u.isSpecialDescriptorProperty=function(a){return da.hasOwnProperty(a)};
u.defineEventProperty=function(a,b,c){let d=`${b}\u27a4handler`;Object.defineProperty(a.prototype,b,{get(){return this[d]},set(a){let b=this[d];(a||null)!==(b||null)&&("function"===typeof b&&this.removeEventListener(c,b),"function"===typeof a&&this.addEventListener(c,a),this[d]=a)}})};let N=[null],O=B("animatable",function(a){function b(b,e){if(!c.prototype.hasOwnProperty(b)){let d=`${b}\u27a4anim:actualValue`,e=`${b}\u27a4anim:actuallySet`,k=`${b}\u27a4anim:hasBeenSet`,g=`${b}\u27a4anim:tween`,m,
h,n=a.prototype;for(;n;){let a=Object.getOwnPropertyDescriptor(n,b);if(a){h=a.set;m=a.get;if(h&&!m||m&&!h)throw Error(`Animatable: property ${b} has a custom ${h?"setter":"getter"} but no ${h?"getter":"setter"}. Animatable properties must have both.`);break}n=Object.getPrototypeOf(n)}let p=h?function(a){h.call(this,a);this[k]||(this[k]=!0)}:function(a){this[d]=a;this[k]||(this[k]=!0)};Object.defineProperty(c.prototype,e,{value:p});Object.defineProperty(c.prototype,b,{get(){return m?m.call(this):this[k]?
this[d]:a.prototype[b]},set(a){if(!this.animation$animatingProps||!this.animation$animatingProps[b]){var d=this.animation$runner,c=this.transition;if(c&&c[b]&&this[k]&&c.hasOwnProperty(b)){c=c[b];let e="spring"===c?"default":c.spring,f=this[g],h=!1;f?a!==f.toValue&&(e&&f.isSpring?f.toValue=a:(d.stop(f),h=!0)):a!==this[b]&&(h=!0);h&&(f=this[g]=e?new v.SpringTween(p.bind(this),this[b],a,e,0,c.delay||0):new v.Tween(p.bind(this),this[b],a,c.duration||750,c.delay||0,c.easing||"easeOutCubic",1,"forward",
c.interpolate||"number"),f.onDone=()=>{f=this[g]=null},d.start(f))}else p.call(this,a),(a=this[g])&&d.stop(a),this[g]=null}}})}e.hasOwnProperty(b)&&(e[`${b}\u27a4anim:actualValue`]=e[b],e[`${b}\u27a4anim:hasBeenSet`]=!0,delete e[b])}class c extends a{constructor(...a){super(...a);this.animation$runner=new v.Runner;this.animation$runner.onTick=()=>{this.afterUpdate();this.requestRender()}}set transition(a){if(a)for(let c in a)a.hasOwnProperty(c)&&b(c,this);this.transition$descriptor=a}get transition(){return this.transition$descriptor}set animation(a){if(this.animation$descriptor!==
a){this.animation$descriptor=a;var c=this.animation$tweens||null,d=this.animation$tweens=a?Object.create(null):null,l=this.animation$runner,k=!1;a&&!Array.isArray(a)&&(N[0]=a,a=N);if(a)for(let e=0,f=a.length;e<f;e++){var g=a[e];if(g){var m=JSON.stringify(g,Y);if(c&&m in c){var h=c[m];g.paused?l.pause(h):l.start(h);d[m]=h}else{k=0;let a=750,c="linear",e=1;h=[];let f="forward";for(let d in g)if(g.hasOwnProperty(d))switch(d){case "duration":a=g[d];break;case "delay":k=g[d];break;case "easing":c=g[d];
break;case "iterations":e=g[d];break;case "direction":f=g[d];break;default:var n="from"===d?0:"to"===d?100:parseFloat(d);if(!isNaN(n)&&0<=n&&100>=n){h.push({time:n/100,props:g[d]});for(let a in g[d])g[d].hasOwnProperty(a)&&(b(a,this),n=a+"\u27a4anim:tween",this[n]&&(l.stop(this[n]),this[n]=null))}}if(h.length){h.sort(Z);0<h[0].time&&h.unshift(K({time:0},h[0]));n=[];for(let b=1,c=h.length;b<c;b++){let c=h[b],d=c.props;for(let e in d)if(d.hasOwnProperty(e)){var p=null;for(let a=b;a--;)if(e in h[a].props){p=
h[a];break}p&&(p=new v.Tween(this[e+"\u27a4anim:actuallySet"].bind(this),p.props[e],d[e],(c.time-p.time)*a,p.time*a,"linear",1,"forward",g.interpolate&&g.interpolate[e]||"number"),p.$$property=e,n.push(p))}}m=d[m]=new v.MultiTween(n,a,k,c,e,f);g.paused||l.start(m);if(0===k){g=h[0].props;for(let a in g)if(g.hasOwnProperty(a))this[a+"\u27a4anim:actuallySet"](g[a])}}k=!0}}}if(c)for(var y in c)d&&d[y]||(a=c[y],a.gotoEnd(),l.stop(a),k=!0);if(k)if(d){c=this.animation$animatingProps=Object.create(null);
for(let a in d)for(l=d[a].tweens,y=l.length;y--;)c[l[y].$$property]=!0}else this.animation$animatingProps=null}}get animation(){return this.animation$descriptor}destructor(){const a=this.animation$runner;if(this.exitAnimation&&!this.parent.isDestroying){a.stopAll();this.animation=this.exitAnimation;this.exitAnimation=this.transition=null;const b=a.onTick;a.onTick=()=>{this.parent&&!this.parent.isDestroying?b():(a.onDone=null,this.destructor())};a.onDone=()=>{this.requestRender();this.destructor()}}else a.destructor(),
super.destructor()}}return c}),P=B("pointerStates",function(a){function b(b,c){const d=`${b}\u27a4pntr:hasBeenSet`;c[d]||(c[`${b}\u27a4pntr:baseValue`]=c[b],delete c[b],c[d]=!0);if(!m.prototype.hasOwnProperty(b)){g[b]=1;const c=`${b}\u27a4pntr:baseValue`,d=`${b}\u27a4pntr:appliedValue`;Object.defineProperty(m.prototype,b,{get(){a:{var e=a.prototype;if(b in e)for(;e;){let a=Object.getOwnPropertyDescriptor(e,b);if(a&&a.get){e=a.get;break a}e=Object.getPrototypeOf(e)}e=null}return e?e.call(this):d in
this?this[d]:this[c]},set(a){this[c]=a}})}}function c(b,c,d){a:{var e=a.prototype;if(c in e)for(;e;){let a=Object.getOwnPropertyDescriptor(e,c);if(a&&a.set){e=a.set;break a}e=Object.getPrototypeOf(e)}e=null}e?e.call(b,d):b[`${c}\u27a4pntr:appliedValue`]=d}function d(a){a.currentTarget["\u27a4pntr:isHovering"]=!0;k(a)}function e(a){a.currentTarget["\u27a4pntr:isHovering"]=a.currentTarget["\u27a4pntr:isActive"]=!1;k(a)}function f(a){a.currentTarget["\u27a4pntr:isActive"]=!0;k(a)}function l(a){a.currentTarget["\u27a4pntr:isActive"]=
!1;k(a)}function k(a){a=a.currentTarget;let b=a.parent;for(;b&&b.shouldUpdateChildren();)b.isPointerStateAware&&(a=b),b=b.parent;a.afterUpdate();a.requestRender()}const g=Object.create(null);class m extends a{constructor(a){super(a);this.addEventListener("mouseover",d);this.addEventListener("mouseout",e);this.addEventListener("mousedown",f);this.addEventListener("mouseup",l)}afterUpdate(){this._applyPointerStates();super.afterUpdate()}_applyPointerStates(){var a=this.pointerStates,d=a&&this["\u27a4pntr:isHovering"]&&
a.hover||null;const e=a&&this["\u27a4pntr:isActive"]&&a.active||null;a=this["\u27a4pntr:lastAppliedValues"]||g;if(d=this["\u27a4pntr:lastAppliedValues"]=d||e?w(Object.create(null),d,e):null)for(let a in d)b(a,this),c(this,a,d[a]);if(a)for(let b in a)d&&b in d||c(this,b,this[`${b}\u27a4pntr:baseValue`])}}Object.defineProperty(m.prototype,"isPointerStateAware",{value:!0});return m});class ea extends u{constructor(a){super(a);this._orderedItemKeys=[]}afterUpdate(){let {data:a,template:b}=this;var c=
a&&a.length&&Array.isArray(a);if("production"!==process.env.NODE_ENV){if(a&&!Array.isArray(a))throw Error('ListFacade "data" must be an array.');if(!b||"object"!==typeof b)throw Error('ListFacade "template" must be an object.');if(!b||"function"!==typeof b.key)throw Error('ListFacade template must define a "key" function.');if(!b||"function"!==typeof b.facade)throw Error('ListFacade template must define a "facade".');}if(this.shouldUpdateChildren()){let f=this._itemsDict||null,l=this._itemsDict=c?
Object.create(null):null,k=this._orderedItemKeys;if(c){k.length=a.length;for(let g=0,m=a.length;g<m;g++){c=a[g];let h=b.key(c,g,a);var d=b.facade;if("production"!==process.env.NODE_ENV){if(null==h)throw Error('ListFacade template "key" function must return a key.');l[h]&&console.warn(`Duplicate key in list: ${h}`)}for(;l[h];)h+="|dupe";let m="function"===typeof b.transition?b.transition(c,g,a):b.transition,p="function"===typeof b.animation?b.animation(c,g,a):b.animation;var e="function"===typeof b.exitAnimation?
b.exitAnimation(c,g,a):b.exitAnimation;if(m||p||e)d=O(d);e=b.pointerStates;if("function"===e?e(c,g,a):e)d=P(d);(e=f&&f[h])&&e.constructor===d?d=e:(e&&e.destructor(),d=new d(this));d.transition=m;d.animation=p;for(let e in b)b.hasOwnProperty(e)&&!u.isSpecialDescriptorProperty(e)&&(d[e]="function"===typeof b[e]?b[e](c,g,a):b[e]);d.afterUpdate();l[h]=d;k[g]=h}}if(f)for(let a in f)l&&l[a]||f[a].destructor()}super.afterUpdate()}shouldUpdateChildren(){return!0}traverse(a,b){a.call(b,this);let c=this._orderedItemKeys,
d=this._itemsDict;for(let e=0,f=c.length;e<f;e++)d[c[e]].traverse(a,b)}forEachChild(a,b){let c=this._orderedItemKeys,d=this._itemsDict;for(let e=0,f=c.length;e<f;e++)a.call(b,d[c[e]],c[e])}destructor(){this.isDestroying=!0;let a=this._itemsDict;if(a)for(let b in a)a[b].destructor();super.destructor()}}let Q=[null];class E extends u{constructor(a){super(a);this.children=null;this._orderedChildKeys=[]}afterUpdate(){this.shouldUpdateChildren()&&this.updateChildren(this.describeChildren());super.afterUpdate()}describeChildren(){return this.children}shouldUpdateChildren(){return!0}updateChildren(a){let b=
this._childrenDict||null,c=this._childrenDict=null,d=this._orderedChildKeys;d.length=0;if(a){Array.isArray(a)||(Q[0]=a,a=Q);for(let k=0,g=a.length;k<g;k++){var e=a[k];if(!e)continue;c||(c=this._childrenDict=Object.create(null));var f=M(e);let g=f?e.props:e;f=f?e.type:e.facade;e=e.key;if(!e){var l=0;do e=`auto:${f.name}:${l++}`;while(c[e])}if("production"!==process.env.NODE_ENV&&"function"!==typeof f)throw Error('All scene objects must have a "facade" property pointing to a class/constructor');if(c[e])for(console.warn(`Duplicate key in children: ${e}`);c[e];)e+=
"|dupe";l=g.transition;let h=g.animation;if(l||h||g.exitAnimation)f=O(f);g.pointerStates&&(f=P(f));let n=b&&b[e];n&&n.constructor===f?f=n:(n&&n.destructor(),f=new f(this));f.transition=l;f.animation=h;for(let a in g)g.hasOwnProperty(a)&&!u.isSpecialDescriptorProperty(a)&&(f[a]=g[a]);c[e]=f;d.push(e);f.afterUpdate()}}if(b)for(let a in b)c&&c[a]||b[a].destructor()}getChildByKey(a){let b=this._childrenDict;return b&&b[a]||null}traverse(a,b){a.call(b,this);let c=this._orderedChildKeys,d=this._childrenDict;
for(let e=0,f=c.length;e<f;e++)d[c[e]].traverse(a,b)}forEachChild(a,b){let c=this._orderedChildKeys,d=this._childrenDict;for(let e=0,f=c.length;e<f;e++)a.call(b,d[c[e]],c[e])}destructor(){this.isDestroying=!0;let a=this._childrenDict;if(a)for(let b in a)a[b].destructor();super.destructor()}}var A="onMouseOver onMouseOut onMouseMove onDragStart onDrag onDragEnter onDragOver onDragLeave".split(" ");let R="onMouseDown onMouseUp onClick onDoubleClick onDrop onDragEnd onWheel".split(" "),S=R.map(C),T=
A.map(C);A=A.concat(R);let U=T.concat(S);class F extends E{interceptsPointerEvents(a){if(!1===this.pointerEvents)return!1;if(this.pointerEvents)return!0;for(let b=0,c=U.length;b<c;b++)if(a.hasFacadeListenersOfType(this,U[b]))return!0}}Object.defineProperty(F.prototype,"isPointerEventTarget",{value:!0});A.forEach(a=>{u.defineEventProperty(F,a,C(a))});let fa={},ha=["mousemove","mouseout","touchmove"],ia="mousedown mouseup click dblclick wheel touchstart touchend touchcancel".split(" "),V=["mouseup",
"touchend","touchcancel"],ja={touchstart:"mousedown",touchend:"mouseup",touchcancel:"mouseup"},ka="clientX clientY screenX screenY pageX pageY".split(" ");class z{constructor(a,b,c,d,e){for(let b in a)"function"!==typeof a[b]&&(this[b]=a[b]);this.target=c;this.relatedTarget=d;this.type=b;this.nativeEvent=a;w(this,e);if(a.touches){let b=D(a)?a.changedTouches:a.touches;1===b.length&&ka.forEach(a=>{this[a]=b[0][a]})}}preventDefault(){this.defaultPrevented=!0;this.nativeEvent.preventDefault()}stopPropagation(){this.propagationStopped=
!0;this.nativeEvent.stopPropagation()}}class G extends E{constructor(a){super(null);this.width=this.height=1;this._element=a;this._htmlOverlays=Object.create(null);this.eventRegistry=new aa;this._onPointerMotionEvent=this._onPointerMotionEvent.bind(this);this._onPointerActionEvent=this._onPointerActionEvent.bind(this);this._onDropEvent=this._onDropEvent.bind(this);this._togglePointerListeners(!0)}afterUpdate(){this._queueRender();super.afterUpdate()}onNotifyWorld(a,b,c){(b=this._notifyWorldHandlers[b])&&
b.call(this,a,c)}_isContinuousRender(){return this.continuousRender}set renderingScheduler(a){a=a||window;if(a!==this.renderingScheduler){let b=this._nextFrameTimer;b&&(this.renderingScheduler.cancelAnimationFrame(b),this._nextFrameTimer=null);this._renderingScheduler=a}}get renderingScheduler(){return this._renderingScheduler||window}_queueRender(){if(!this._nextFrameTimer){let a=this._nextFrameHandler||(this._nextFrameHandler=(...a)=>{let {onStatsUpdate:b,onBeforeRender:d,onAfterRender:e}=this,
f=b&&Date.now();d&&d(this);this.doRender(...a);b&&(a=Date.now(),b({"Render CPU Time (ms)":a-f,"Time Between Frames (ms)":this._lastFrameTime?a-this._lastFrameTime:"?",FPS:this._lastFrameTime?Math.round(1E3/(a-this._lastFrameTime)):"?"}),this._lastFrameTime=a);this._doRenderHtmlItems();e&&e(this);this._nextFrameTimer=null;this._isContinuousRender()&&this._queueRender()});this._nextFrameTimer=this.renderingScheduler.requestAnimationFrame(a)}}doRender(){}getFacadeUserSpaceXYZ(a){}_doRenderHtmlItems(){if(this.renderHtmlItems){let a=
[],b=this._htmlOverlays;for(let c in b){let d=b[c],e=this.getFacadeUserSpaceXYZ(d);0<=e.z&&(e.key=d.$facadeId,e.html=d.html,e.exact=d.exact,a.push(e))}this.renderHtmlItems(a)}}_normalizePointerEvent(a){}_onPointerMotionEvent(a){this._normalizePointerEvent(a);let b=this._getPointerEventState(a);if(T.some(this.eventRegistry.hasAnyListenersOfType)){var c="mouseout"===a.type||D(a)?null:this._findHoverTarget(a);let d=b.hoveredFacade,e=b.hoveredFacade=c&&c.facade,f=b.dragInfo;f&&(f.dragStartFired||(this._firePointerEvent("dragstart",
f.dragStartEvent,f.draggedFacade,null,c),f.dragStartFired=!0),this._firePointerEvent("drag",a,f.draggedFacade,null,c));e!==d&&(d&&(this._firePointerEvent("mouseout",a,d,e,c),f&&this._firePointerEvent("dragleave",a,d,e,c)),e&&(this._firePointerEvent("mouseover",a,e,d,c),f&&this._firePointerEvent("dragenter",a,e,d,c)));e&&(this._firePointerEvent("mousemove",a,e,null,c),f&&this._firePointerEvent("dragover",a,e,null,c))}(c=b.tapInfo)&&"touchmove"===a.type&&(a=a.changedTouches[0])&&10<Math.sqrt(Math.pow(a.clientX-
c.x,2)+Math.pow(a.clientY-c.y,2))&&(b.tapInfo=null)}_onPointerActionEvent(a){this._normalizePointerEvent(a);-1<V.indexOf(a.type)&&this._onDropEvent(a);"touchstart"===a.type&&(1===a.touches.length&&this._onPointerMotionEvent(a),this._enableContextMenu(!1));var b=this.eventRegistry;if(b.hasAnyListenersOfType("dragstart")||S.some(b.hasAnyListenersOfType)){var c=this._findHoverTarget(a);let d=c&&c.facade;if(d){let e=this._getPointerEventState(a);this._firePointerEvent(ja[a.type]||a.type,a,d,null,c);if(b.findBubblingEventTarget(d,
"click")||b.findBubblingEventTarget(d,"dblclick")){let b=e.tapInfo;"touchstart"===a.type&&1===a.touches.length?e.tapInfo={facade:d,x:a.touches[0].clientX,y:a.touches[0].clientY,startTime:Date.now(),isDblClick:b&&300>Date.now()-b.startTime}:b&&b.facade===d&&"touchend"===a.type&&0===a.touches.length&&1===a.changedTouches.length&&300>Date.now()-b.startTime&&(this._firePointerEvent("click",a,d,null,c),b.isDblClick&&this._firePointerEvent("dblclick",a,d,null,c))}if("mousedown"===a.type||"touchstart"===
a.type)if(b=b.findBubblingEventTarget(d,"dragstart"))c=new z(a,"dragstart",b,null,{intersection:c}),e.dragInfo={draggedFacade:b,dragStartFired:!1,dragStartEvent:c},this._toggleDropListeners(!0)}a.preventDefault()}D(a)&&(1===a.changedTouches.length&&this._onPointerMotionEvent(a),this._enableContextMenu(!0))}_onDropEvent(a){let b=this._getPointerEventState(a),c=b.dragInfo;if(c){this._normalizePointerEvent(a);let d=this._findHoverTarget(a),e=d&&d.facade;e&&this._firePointerEvent("drop",a,e,null,d);this._firePointerEvent("dragend",
a,c.draggedFacade,null,d);this._toggleDropListeners(!1);b.dragInfo=null}}_firePointerEvent(a,b,c,d,e){a=b instanceof z?b:new z(b,a,c,d,{bubbles:!0,intersection:e});this.eventRegistry.dispatchEventOnFacade(c,a)}_getPointerEventState(a){let b=this._pointerEventStates||(this._pointerEventStates=new WeakMap);a=a.eventSource||fa;let c=b.get(a);c||b.set(a,c={});return c}_toggleDropListeners(a){V.forEach(b=>{document[(a?"add":"remove")+"EventListener"](b,this._onDropEvent,!0)})}_togglePointerListeners(a){let b=
this._element;if(b&&a!==this._pointerListenersAttached){let c=(a?"add":"remove")+"EventListener";ha.forEach(a=>{b[c](a,this._onPointerMotionEvent,!1)});ia.forEach(a=>{b[c](a,this._onPointerActionEvent,!1)});this._pointerListenersAttached=a}}_enableContextMenu(a){let b=this._element;if(b)b[(a?"remove":"add")+"EventListener"]("contextmenu",ba,!0)}getFacadesAtEvent(a,b){throw Error("getFacadesAtEvent: no impl");}_findHoverTarget(a){if(a.touches&&1<a.touches.length)return null;if(a=this.getFacadesAtEvent(a,
a=>a.isPointerEventTarget&&a.interceptsPointerEvents(this.eventRegistry))){let b=a[0];for(let c=1;c<a.length;c++)if(a[c].distance<b.distance||a[c].distance===b.distance&&(a[c].distanceBias||0)<(b.distanceBias||0))b=a[c];return b}return null}destructor(){this._nextFrameTimer&&this.renderingScheduler.cancelAnimationFrame(this._nextFrameTimer);this._togglePointerListeners(!1);this._toggleDropListeners(!1);super.destructor()}}Object.defineProperty(G.prototype,"isWorld",{value:!0});G.prototype._notifyWorldHandlers=
{needsRender(){this._queueRender()},addEventListener(a,b){this.eventRegistry.addListenerForFacade(a,b.type,b.handler)},removeEventListener(a,b){this.eventRegistry.removeListenerForFacade(a,b.type,b.handler)},removeAllEventListeners(a){this.eventRegistry.removeAllListenersForFacade(a)},dispatchEvent(a,b){b instanceof z||(b=new z(b,b.type,b.target,b.relatedTarget));this.eventRegistry.dispatchEventOnFacade(a,b)},addHtmlOverlay(a){this._htmlOverlays[a.$facadeId]=a},removeHtmlOverlay(a){delete this._htmlOverlays[a.$facadeId]},
statsUpdate(a,b){(a=this.onStatsUpdate)&&a(b)}};let la={position:"absolute",top:0,right:0,bottom:0,left:0,pointerEvents:"none",transformStyle:"preserve-3d"};class H extends r["default"].Component{shouldComponentUpdate(a){return a.html!==this.props.html||!0===(a.html.props&&a.html.props.shouldUpdateOnMove)}render(){let a=this.props.html;return"string"===typeof a?r["default"].createElement("span",null,a):r["default"].cloneElement(a)}}H.displayName="Canvas3D.HtmlOverlayContent";H.propTypes={html:t["default"].node};
class W extends r["default"].Component{constructor(a){super(a);this.setItems=this.setItems.bind(this);this.state={items:null}}shouldComponentUpdate(a,b){a=this.state;return b.items&&b.items.length||a.items&&a.items.length}setItems(a){let b=this.state.items;(a&&a.length||b&&b.length)&&this.setState({items:a||null})}render(){let a=this.state.items,b=Math.round;return a&&a.length?r["default"].createElement("div",{className:"troika_html_overlay",style:la},a.map(({key:a,html:d,x:e,y:f,z:l,exact:k})=>{k||
(e=b(e),f=b(f));return r["default"].createElement("div",{key:a,style:{position:"absolute",transform:`translate3d(${e}px, ${f}px, ${-l}px)`}},r["default"].createElement(H,{html:d}))})):null}}W.displayName="Canvas3D.HtmlOverlay";let ma={position:"absolute",top:0,right:0,background:"rgba(0,0,0,.5)",font:"11px sans-serif",padding:10};class na extends r["default"].Component{constructor(a){super(a);this.state={stats:{}}}setStats(a){this.setState({stats:a})}render(){let a=this.state.stats;return r["default"].createElement("div",
{style:ma},Object.keys(a).sort().map(b=>r["default"].createElement("div",{key:b},`${b}: ${a[b]}`)))}}let oa={width:"100%",height:"100%"};class X extends r["default"].Component{constructor(a){super(a);this._stats={};this.updateStats=this.updateStats.bind(this);this.renderHtmlItems=this.renderHtmlItems.bind(this);this._bindHtmlOverlayRef=this._bindHtmlOverlayRef.bind(this);this._bindCanvasRef=this._bindCanvasRef.bind(this);this._bindStatsRef=this._bindStatsRef.bind(this)}componentDidUpdate(){this.updateWorld()}initWorld(a){a=
new this.props.worldFacade(a);a.renderHtmlItems=this.renderHtmlItems;return a}updateWorld(){let a=this._world;if(a){let {props:b}=this,c=b.stats,d=c&&Date.now();a.width=b.width;a.height=b.height;a.pixelRatio=b.pixelRatio;a.continuousRender=b.continuousRender;a.onStatsUpdate=c?this.updateStats:null;w(a,b.worldProps);a.afterUpdate();c&&this.updateStats({"Last World Update (ms)":Date.now()-d})}}destroyWorld(){this._world&&(this._world.destructor(),delete this._world);clearTimeout(this._statsDelay)}renderHtmlItems(a){this._htmlOverlayRef&&
this._htmlOverlayRef.setItems(a)}updateStats(a){this._stats=w({},this._stats,a);this._statsDelay||(this._statsDelay=setTimeout(()=>{this._statsDelay=null;let a=this._statsRef;a&&a.setStats(this._stats)},250))}_bindHtmlOverlayRef(a){this._htmlOverlayRef=a}_bindCanvasRef(a){if(a)try{this._world=this.initWorld(a),this.updateWorld()}catch(c){console.warn(`Troika.${this.constructor.displayName}: world init failed, using fallback content.`,c),this._failedWorldInit=!0,this._world=null,this.forceUpdate()}else this.destroyWorld();
let b=this.props.onCanvasRef;b&&b(a)}_bindStatsRef(a){this._statsRef=a}render(){let {props:a}=this;return r["default"].createElement("div",{className:`troika ${a.className||""}`,style:{position:"relative",overflow:"hidden",width:a.width,height:a.height,cursor:a.cursor,userSelect:"none"}},this._failedWorldInit?this.props.children:r["default"].createElement("canvas",{className:"troika_canvas",ref:this._bindCanvasRef,style:a.canvasStyle||oa}),r["default"].createElement(W,{ref:this._bindHtmlOverlayRef}),
a.stats?r["default"].createElement(na,{ref:this._bindStatsRef}):null)}}X.commonPropTypes={width:t["default"].number.isRequired,height:t["default"].number.isRequired,pixelRatio:t["default"].number,worldFacade:t["default"].func,worldProps:t["default"].object,canvasStyle:t["default"].object,className:t["default"].string,continuousRender:t["default"].bool,onCanvasRef:t["default"].func,stats:t["default"].bool,cursor:t["default"].string};q.Facade=u;q.ListFacade=ea;q.ParentFacade=E;q.PointerEventTarget=
F;q.ReactCanvasBase=X;q.WorldBaseFacade=G;q.utils=x;Object.defineProperty(q,"__esModule",{value:!0})})
