'use strict';(function(f,e){"object"===typeof exports&&"undefined"!==typeof module?e(exports,require("three"),require("troika-core"),require("troika-three-utils"),require("react"),require("prop-types")):"function"===typeof define&&define.amd?define("exports three troika-core troika-three-utils react prop-types".split(" "),e):(f="undefined"!==typeof globalThis?globalThis:f||self,e(f.troika_3d={},f.THREE,f.troika_core,f.troika_three_utils,f.React,f.PropTypes))})(this,function(f,e,k,u,m,G){function O(a){return a&&
"object"===typeof a&&"default"in a?a:{"default":a}}function wa(a,b){return a.distance-b.distance}function P(a){return!1===a.isRenderable&&(!a.children.length||a.children.every(P))}function Q(a,b,c){function d(a,b){Object.defineProperty(g.prototype,a,{set(c){c!==this.threeObject[a]&&(this.threeObject[a]=c,b&&(this._projectionChanged=!0))},get(){return this.threeObject[a]}})}class g extends q{constructor(a){super(a);this.lookAt=this.up=null;this._projectionChanged=!1;this._frustum=new e.Frustum}initThreeObject(){let b=
new a;b.updateMatrixWorld=xa;return b}afterUpdate(){this.lookAt&&(R.copy(this.lookAt),S.copy(this.up||e.Object3D.DefaultUp),T.lookAt(this.threeObject.position,R,S),A.setFromRotationMatrix(T),this.quaternionX=A.x,this.quaternionY=A.y,this.quaternionZ=A.z,this.quaternionW=A.w);super.afterUpdate()}updateMatrices(){let a=this.threeObject;this._projectionChanged&&(a.updateProjectionMatrix(),this._projectionChanged=!1,this._projectionMatrixVersion=ya++);let b=this._worldMatrixVersion;super.updateMatrices();
b!==this._worldMatrixVersion&&u.invertMatrix4(a.matrixWorld,a.matrixWorldInverse)}getFrustum(){this.updateMatrices();let a=this._frustum,{_worldMatrixVersion:b,_projectionMatrixVersion:c}=this;if(a._lastWorldMatrixVersion!==b||a._lastProjMatrixVersion!==c){var d=this.threeObject;d=(new e.Matrix4).multiplyMatrices(d.projectionMatrix,d.matrixWorldInverse);a.setFromMatrix(d);a._lastWorldMatrixVersion=b;a._lastProjMatrixVersion=c}return a}getRayAtProjectedCoords(a,b){let c=U.ray=new e.Ray;U.setFromCamera(za.set(a,
b),this.threeObject);return c}}b.forEach(a=>{d(a,!0)});c&&c.forEach(a=>{d(a,!1)});return g}function x(a,b,c){let d=class extends V{initThreeObject(){return new a}set showHelper(a){let c=this._helper;!!a!==!!c&&(a?this.threeObject.add(this._helper=new b(this.threeObject)):c&&(c.dispose(),this.threeObject.remove(c),this._helper=null))}afterUpdate(){super.afterUpdate();this._helper&&this._helper.update()}};c&&Object.defineProperties(d.prototype,c);return d}function Aa(a,b){let c=b?b.sort().join("|"):
"",d=W.get(a);d&&d._instanceUniformsKey===c||(d=u.createDerivedMaterial(a,{defines:{TROIKA_INSTANCED_UNIFORMS:c},customRewriter({vertexShader:a,fragmentShader:c}){return Ba(a,c,b)}}),d._instanceUniformsKey=c,W.set(a,d));return d}function Ba(a,b,c){let d=X.test(a),g=Y.test(a),p=Z.test(a),e=u.getShaderUniformTypes(a),l=u.getShaderUniformTypes(b),h=["\nattribute vec4 troika_modelMatrixRow0;\nattribute vec4 troika_modelMatrixRow1;\nattribute vec4 troika_modelMatrixRow2;\nmat4 troika_modelMatrix;\nmat4 troika_modelViewMatrix;\nmat3 troika_normalMatrix;\n"],
f=[],r=[];if(d||g||p)a=a.replace(X,D),f.push(Ca);if(g||p)a=a.replace(Y,D),f.push("\ntroika_modelViewMatrix = viewMatrix * troika_modelMatrix;\n");p&&(a=a.replace(Z,D),f.push("\ntroika_normalMatrix = transposeMat3(inverse(mat3(troika_modelViewMatrix)));\n"),/\binverse\s*\(/.test(a)||h.push("\n#if __VERSION__ < 300\n// matrix inversion utility for pre-ES3 - credit https://github.com/stackgl/glsl-inverse\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(\n    b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n    b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n    b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)\n  ) / det;\n}\n#endif\n"));
c&&c.forEach(c=>{var d=e[c];let g=l[c];if(d||g){let p=new RegExp(`\\b${c}\\b`,"g");h.push(`attribute ${d||g} troika_${c};`);d&&(a=a.replace(p,D));g&&(b=b.replace(p,Da),d=`varying ${g} troika_vary_${c};`,h.push(d),r.push(d),f.push(`troika_vary_${c} = troika_${c};`))}});a=`
${h.join("\n")}
${a.replace(u.voidMainRegExp,`
  $&
  ${f.join("\n")}
`)}`;r.length&&(b=`
${r.join("\n")}
${b}`);return{vertexShader:a,fragmentShader:b}}function aa(a,b,c){let d=a.itemSize;1===d?a.setX(b,c):2===d?a.setXY(b,c.x,c.y):3===d?c.isColor?a.setXYZ(b,c.r,c.g,c.b):a.setXYZ(b,c.x,c.y,c.z):4===d&&a.setXYZW(b,c.x,c.y,c.z,c.w)}function ba(a,b){let c=a.uniforms;return c&&c[b]?c[b].value:(c=u.getShadersForMaterial(a).uniforms)&&c[b]?c[b].value:null}function H(a){return a[a.hasOwnProperty("instanceCount")?"instanceCount":"maxInstancedCount"]}function ca(a,b){a[a.hasOwnProperty("instanceCount")?"instanceCount":
"maxInstancedCount"]=b}var da=O(m);m=O(G);let {assign:Ea,forOwn:ea}=k.utils,fa=new e.Vector3,Fa=new e.Vector3,t=function(){const a={callback:function(b){a.value=b},value:null};return a}(),Ga={type:"removed"},B=[],Ha=0,Ia=0;class q extends k.PointerEventTarget{constructor(a,b){super(a);b||(b=this.initThreeObject());b.matrixAutoUpdate=!1;this.threeObject=b;b.$facade=this;let c=!1!==b.isRenderable;c||(b.layers.mask=0);for(;a;){if(a.isObject3DFacade){this._parentObject3DFacade=a;c&&this._addToThreeObjectTree();
break}a=a.parent}this.notifyWorld("object3DAdded")}initThreeObject(){let a=new e.Object3D;a.isRenderable=!1;return a}afterUpdate(){this.updateMatrices();this._checkBoundsChange();this._worldMatrixVersion>this._worldMatrixVersionAfterLastUpdate&&(this.shouldUpdateChildren()||this.traverse((a,b)=>{a!==b&&a.updateMatrices&&(a.updateMatrices(),a._checkBoundsChange())},this),this._worldMatrixVersionAfterLastUpdate=this._worldMatrixVersion);super.afterUpdate();this._flushQueuedChildRemovals()}updateMatrices(){var a=
this.threeObject;let b=this._parentObject3DFacade,c;this._matrixChanged?(a.matrix.compose(a.position,a.quaternion,a.scale),this._matrixChanged=!1,c=!0):c=b&&b._worldMatrixVersion>this._worldMatrixVersion;if(c){b?a.matrixWorld.multiplyMatrices(b.threeObject.matrixWorld,a.matrix):a.matrixWorld.copy(a.matrix);a=a.children;for(let b=0,c=a.length;b<c;b++)a[b].$facade||a[b].updateMatrixWorld(!0);this.markWorldMatrixDirty()}}markWorldMatrixDirty(){this._worldMatrixVersion=++Ha;this._boundsChanged=!0}_checkBoundsChange(){let a=
this._boundsChanged;if(!a){let b=this._getGeometryBoundingSphere();b&&b.version!==this._lastGeometrySphereVersion&&(a=!0,this._lastGeometrySphereVersion=b.version)}a&&(this.notifyWorld("object3DBoundsChanged"),this._boundsChanged=!1)}getWorldPosition(a){this.updateMatrices();return(a||new e.Vector3).setFromMatrixPosition(this.threeObject.matrixWorld)}getCameraPosition(a){a=a||new e.Vector3;this.notifyWorld("getCameraPosition",a);return a}getCameraFacade(){t.value=null;this.notifyWorld("getCameraFacade",
t);return t.value}getCameraDistance(){let a=this.getCameraPosition(Fa),b=this.getWorldPosition(fa);return a.distanceTo(b)}getProjectedPosition(a,b,c){this.updateMatrices();t.value=null;t.worldPosition=fa.set(a||0,b||0,c||0).applyMatrix4(this.threeObject.matrixWorld);this.notifyWorld("projectWorldPosition",t);return t.value}getSceneFacade(){t.value=null;this.notifyWorld("getSceneFacade",t);return t.value}getBoundingSphere(){let a=this._getGeometryBoundingSphere();if(!a)return null;this.updateMatrices();
let b=this._boundingSphere;b||(b=this._boundingSphere=new e.Sphere);if(b._geometrySphereVersion!==a.version||b._worldMatrixVersion!==this._worldMatrixVersion)b.copy(a),b.applyMatrix4(this.threeObject.matrixWorld),b._worldMatrixVersion=this._worldMatrixVersion,b._geometrySphereVersion=a.version;return b}_getGeometryBoundingSphere(){let a=this.getGeometry();if(a){let b=a.boundingSphere,c=!1;if(b)if(a.isBufferGeometry){let d=a.attributes.position;d&&b._posAttrVersion!==d.version&&(a.computeBoundingSphere(),
b._posAttrVersion=d.version,c=!0)}else a._lastBoundingSphere&&b.equals(a._lastBoundingSphere)||(a._lastBoundingSphere=b.clone(),c=!0);else a.computeBoundingSphere(),b=a.boundingSphere,c=!0;c&&(b.version=++Ia);return b}return null}getGeometry(){let a=this.threeObject;return a&&a.geometry}raycast(a){return this.threeObject?this._raycastObject(this.threeObject,a):null}_raycastObject(a,b){if(a.visible){B.length=0;let c=null,d=this.raycastSide;null!=d&&(c=a.material.side,a.material.side=d);a.raycast(b,
B);null!==c&&(a.material.side=c);if(B.length)return B.sort(wa),B.slice()}return null}_addToThreeObjectTree(){let a=this._parentObject3DFacade;a&&this.threeObject.parent!==a.threeObject&&(a.threeObject.add(this.threeObject),a._addToThreeObjectTree())}_queueRemoveChildObject3D(a){(this._removeChildIds||(this._removeChildIds=Object.create(null)))[a]=!0}_flushQueuedChildRemovals(){if(this._removeChildIds){let a=this.threeObject,b=this._removeChildIds;a.children=a.children.filter(a=>a.id in b?(a.parent=
null,a.dispatchEvent(Ga),!1):!0);let c=this._parentObject3DFacade;P(a)&&c&&c.threeObject===a.parent&&(c._queueRemoveChildObject3D(a.id),c._flushQueuedChildRemovals());this._removeChildIds=null}}destructor(){this.notifyWorld("object3DRemoved");let a=this._parentObject3DFacade;a&&a._queueRemoveChildObject3D(this.threeObject.id);delete this.threeObject;super.destructor()}}["castShadow","receiveShadow","renderOrder","visible"].forEach(a=>{Object.defineProperty(q.prototype,a,{get(){return this.threeObject[a]},
set(b){this.threeObject[a]=b}})});q.prototype.raycastSide=null;ea({position:{x:"x",y:"y",z:"z"},scale:{x:"scaleX",y:"scaleY",z:"scaleZ"},rotation:{x:"rotateX",y:"rotateY",z:"rotateZ",order:"rotateOrder"},quaternion:{x:"quaternionX",y:"quaternionY",z:"quaternionZ",w:"quaternionW"}},(a,b)=>{ea(a,(a,d)=>{Object.defineProperty(q.prototype,a,{get:(new Function(`return function ${a}$get() {
  return this.threeObject.${b}.${d}
}`))(),set:(new Function(`return function ${a}$set(value) {
  //let obj = this.threeObject.${b}
  if (this.threeObject.${b}.${d} !== value) {
    this.threeObject.${b}.${d} = value
    if (!this._matrixChanged) {
      this._matrixChanged = true
    }
  }
}`))()})})});Object.defineProperty(q.prototype,"scale",{get(){return this.threeObject.scale.x},set(a){let b=this.threeObject.scale;if(a!==b.x||a!==b.y||a!==b.z)b.x=b.y=b.z=a,this._matrixChanged||(this._matrixChanged=!0)}});Object.defineProperty(q.prototype,"isObject3DFacade",{value:!0});Ea(q.prototype,{threeObject:null,_parentObject3DFacade:null,_removeChildIds:null,_matrixChanged:!0,_worldMatrixVersion:-1,_worldMatrixVersionAfterLastUpdate:-1,_boundingSphereChanged:!1});k.Facade.defineEventProperty(q,
"onBeforeRender","beforerender");k.Facade.defineEventProperty(q,"onAfterRender","afterrender");let xa=function(){},U=new e.Raycaster,za=new e.Vector2,R=new e.Vector3,T=new e.Matrix4,A=new e.Quaternion,S=new e.Vector3(0,1,0),ya=0,ha=Q(e.PerspectiveCamera,["fov","aspect","near","far"],["focus","filmGauge","filmOffset"]);G=Q(e.OrthographicCamera,"left right top bottom near far".split(" "));class ia extends q{initThreeObject(){let a=new e.Group;a.isRenderable=!1;return a}}class Ja extends q{constructor(a){let b=
new e.Object3D;b.isRenderable=!1;super(a,b);this.html=null;this.exact=!1;this.notifyWorld("addHtmlOverlay",this)}destructor(){this.notifyWorld("removeHtmlOverlay",this);super.destructor()}}class V extends q{set color(a){this.threeObject.color.set(a)}get color(){return this.threeObject.color.getHex()}get shadow(){return this.threeObject.shadow}set shadow(a){k.utils.assignDeep(this.threeObject.shadow,a)}}"intensity distance angle penumbra decay castShadow width height".split(" ").forEach(a=>{Object.defineProperty(V.prototype,
a,{get(){return this.threeObject[a]},set(b){this.threeObject[a]=b}})});let ja=x(e.AmbientLight),ka=x(e.DirectionalLight,e.DirectionalLightHelper),la=x(e.SpotLight,e.SpotLightHelper),ma=x(e.PointLight,e.PointLightHelper),na=x(e.HemisphereLight,e.HemisphereLightHelper,{groundColor:{set(a){this.threeObject.groundColor.set(a)},get(){return this.threeObject.groundColor.getHex()}}}),Ka=x(e.RectAreaLight),Ca="\ntroika_modelMatrix = mat4(\n  %0.x, %1.x, %2.x, 0.0,\n  %0.y, %1.y, %2.y, 0.0,\n  %0.z, %1.z, %2.z, 0.0,\n  %0.w, %1.w, %2.w, 1.0\n);\n".replace(/%/g,
"troika_modelMatrixRow"),X=/\bmodelMatrix\b/g,Y=/\bmodelViewMatrix\b/g,Z=/\bnormalMatrix\b/g,oa=/\buniform\s+(int|float|vec[234])\s+$/,D=(a,b,c)=>oa.test(c.substr(0,b))?a:`troika_${a}`,Da=(a,b,c)=>oa.test(c.substr(0,b))?a:`troika_vary_${a}`,W=new WeakMap,{assign:I}=k.utils;class J extends ia{constructor(a){super(a);this._instanceables=Object.create(null);this._batchGeometryPool=new La;this._needsRebatch=!0;this.addEventListener("beforerender",this._setupBatchObjects.bind(this));this.addEventListener("afterrender",
this._teardownBatchObjects.bind(this))}onNotifyWorld(a,b,c){let d=this._notifyWorldHandlers[b];if(d)d.call(this,a,c);else if(this.parent)this.parent.onNotifyWorld(a,b,c)}_setupBatchObjects(a,b,c){c=this._instanceables;a=this._batchObjectsByKey;var d=this._needsRebatch;if(!d)for(var g in a)if(this._getBatchKey(a[g][0].$troikaBatchBaseObj)!==g){d=!0;break}if(d){a=this._batchObjectsByKey=Object.create(null);g=this._batchGeometryPool;for(var p in c){d=c[p];var e=d.threeObject,l=d.instancedThreeObject;
if(l&&e.visible){var h=this._getBatchKey(l);let b=this._getInstanceUniformNames(l);var f=a[h]||(a[h]=[]),r=(h=f[f.length-1])&&h.geometry;if(!r||128===H(r)){h=this._getBatchObject(l);r=h.geometry;var k=r._instanceAttrs.matrix;for(var m=0;3>m;m++)k[m].version++;if(b)for(k=r._instanceAttrs.uniforms,m=b.length;m--;)k[b[m]].version++;f.push(h)}f=H(r);ca(r,f+1);k=r._instanceAttrs.matrix;e=e.matrixWorld.elements;k[0].setXYZW(f,e[0],e[4],e[8],e[12]);k[1].setXYZW(f,e[1],e[5],e[9],e[13]);k[2].setXYZW(f,e[2],
e[6],e[10],e[14]);if(b)for(k=r._instanceAttrs.uniforms,e=b.length;e--;){m=b[e];r=k[m];let a=d._instanceUniforms;m=a&&m in a?a[m]:ba(l.material,m);aa(r,f,m)}d._instancingBatchObject=h;d._instancingBatchAttrOffset=f}else d._instancingBatchObject=d._instancingBatchAttrOffset=null}g.disposeUnused()}g=c=p=0;for(let e in a)for(d=a[e],b.children.push.apply(b.children,d),c++,l=d.length;l--;)p++,g+=H(d[l].geometry);this.notifyWorld("statsUpdate",{"Instancing Batch Groups":c,"Instancing Batches":p,"Instanced Objects":g});
this._needsRebatch=!1}_onInstanceAdded(a){this._instanceables[a.$facadeId]=a;this._needsRebatch=!0}_onInstanceRemoved(a){delete this._instanceables[a.$facadeId];this._needsRebatch=!0}_onInstanceChanged(a){this._needsRebatch=!0}_onInstanceMatrixChanged(a){if(!this._needsRebatch){var b=a.instancedThreeObject;let c=a._instancingBatchObject,d=a._instancingBatchAttrOffset;b&&c&&this._getBatchKey(b)===this._getBatchKey(c)?(b=c.geometry._instanceAttrs.matrix,a=a.threeObject.matrixWorld.elements,b[0].setXYZW(d,
a[0],a[4],a[8],a[12]).version++,b[1].setXYZW(d,a[1],a[5],a[9],a[13]).version++,b[2].setXYZW(d,a[2],a[6],a[10],a[14]).version++):(a._instancingBatchObject=a._instancingBatchAttrOffset=null,this._needsRebatch=!0)}}_onInstanceUniformChanged(a,b){if(!this._needsRebatch){let c=a.instancedThreeObject,d=a._instancingBatchObject,g;c&&d&&this._getBatchKey(c)===this._getBatchKey(d)&&(g=d.geometry._instanceAttrs.uniforms[b])?(aa(g,a._instancingBatchAttrOffset,a._instanceUniforms[b]),g.version++):(a._instancingBatchObject=
a._instancingBatchAttrOffset=null,this._needsRebatch=!0)}}_getBatchKey(a){let b=this._batchKeysCache||(this._batchKeysCache=Object.create(null));var c=b&&b[a.id];c||(c=this._getInstanceUniformNames(a),c=`${a.geometry.id}|${a.material.id}|${c?c.sort().join(","):""}`,b[a.id]=c);return c}_getInstanceUniformNames(a){a=a._instanceUniformNames;if(!a)return null;let b=this._uniformNamesCache||(this._uniformNamesCache=new Map),c=b.get(a);c||(c=Array.from(a),b.set(a,c));return c}_getInstanceUniformSizes(a,
b){let c=this._uniformSizesCache||(this._uniformSizesCache=new Map),d=c.get(a);d||(d=Object.create(null),b&&b.forEach(b=>{var c=ba(a,b);c=null==c?0:"number"===typeof c?1:c.isVector2?2:c.isVector3||c.isColor?3:c.isVector4?4:Array.isArray(c)?c.length:0;0<c?d[b]=c:console.warn(`Could not determine item size for uniform ${b}`)}),c.set(a,d));return d}_getBatchObject(a){let {geometry:b,material:c}=a;if(!b.isBufferGeometry)throw Error("Instanceable proto object must use a BufferGeometry");var d=this._getBatchKey(a),
g=this._getInstanceUniformNames(a);let p=this._getInstanceUniformSizes(c,g);d=this._batchGeometryPool.borrow(d,b,p);ca(d,0);let n=Aa(c,g),f,h;g=Object.create(a,{geometry:{value:d},material:{value:n},visible:{value:!0},frustumCulled:{value:!1},customDepthMaterial:{get(){f||(f=n.getDepthMaterial(),f.isShaderMaterial=!0);return f}},customDistanceMaterial:{get(){h||(h=n.getDistanceMaterial(),h.isShaderMaterial=!0,h.uniforms=I({viewMatrix:{value:new e.Matrix4}},h.uniforms));return h}},modelViewMatrix:{value:function(){let a=
new e.Matrix4;a.multiplyMatrices=function(a,b){h&&(h.uniforms.viewMatrix.value.copy(a),h.uniformsNeedUpdate=!0);return e.Matrix4.prototype.multiplyMatrices.call(this,a,b)};return a}()}});g.$troikaBatchBaseObj=a;g.$troikaInstancingManager=this;return g}_teardownBatchObjects(a,b,c){this._batchGeometryPool.releaseAll();this._uniformSizesCache=this._uniformNamesCache=this._batchKeysCache=null;b.children=b.children.filter(a=>a.$troikaInstancingManager!==this)}destructor(){let a=this._batchGeometryPool;
a.releaseAll();a.disposeUnused();super.destructor()}}class La{constructor(){this._poolsByKey=Object.create(null)}borrow(a,b,c){var d=this._poolsByKey;a=d[a]||(d[a]={geometries:[],firstFree:0});d=a.geometries[a.firstFree++];if(!d){d=new e.InstancedBufferGeometry;I(d,b);d.attributes=I({},b.attributes);b=d._instanceAttrs={matrix:[],uniforms:Object.create(null)};for(var g=0;3>g;g++){let a=new e.InstancedBufferAttribute(new Float32Array(512),4);a.setUsage?a.setUsage(35048):a.dynamic=!0;d.attributes[`troika_modelMatrixRow${g}`]=
a;b.matrix[g]=a}for(let a in c)g=c[a],g=new e.InstancedBufferAttribute(new Float32Array(128*g),g),g.setUsage?g.setUsage(35048):g.dynamic=!0,d.attributes[`troika_${a}`]=g,b.uniforms[a]=g;a.geometries.push(d)}return d}releaseAll(){let a=this._poolsByKey;if(a)for(let b in a)a[b].firstFree=0}disposeUnused(){let a=this._poolsByKey;if(a)for(let b in a){let {firstFree:c,geometries:d}=a[b];for(let a=c,b=d.length;a<b;a++){let b=d[a].attributes;for(let a in b)b.hasOwnProperty(a)&&0!==a.indexOf("troika_")&&
delete b[a];try{d[a].dispose()}catch(l){}d[a]._instanceAttrs=null}d.length=c}}}let y=J.prototype;y._notifyWorldHandlers={instanceableAdded:y._onInstanceAdded,instanceableRemoved:y._onInstanceRemoved,instanceableChanged:y._onInstanceChanged,instanceableMatrixChanged:y._onInstanceMatrixChanged,instanceableUniformChanged:y._onInstanceUniformChanged};let Ma={ambient:ja,directional:ka,spot:la,point:ma,hemisphere:na},Na=[{distance:Infinity}],Oa=new e.Sphere(void 0,Infinity),pa=[null];class qa extends q{initThreeObject(){let a=
new e.Scene;a.autoUpdate=!1;return a}afterUpdate(){let a=this.threeObject;a.background=this.background||null;a.environment=this.environment||null;super.afterUpdate()}describeChildren(){let a={key:"instancingMgr",facade:J,children:this.objects},{lights:b}=this;b&&(a=[a],Array.isArray(b)||(pa[0]=b,b=pa),b.forEach((b,d)=>{let c=b.facade||Ma[b.type];if("function"===typeof c){let g=k.utils.assign({},b);delete g.type;g.key=b.key||`light${d}`;g.facade=c;a.push(g)}}));return a}set fog(a){let b=this._fogObj;
if(a){let c="density"in a,d=c?e.FogExp2:e.Fog;b&&b instanceof d||(b=this._fogObj=new d);b.color.set(a.color);c?b.density=a.density:(b.near=a.near,b.far=a.far)}else b=this._fogObj=null;this.threeObject.fog=b}getBoundingSphere(){return Oa}raycast(a){return Na}}let {assign:Pa,forOwn:Qa}=k.utils,K=new e.Sphere,Ra=Math.sqrt(3);class Sa{constructor(){this.root=null;this.keysToLeaves=Object.create(null)}putSpheres(a){Qa(a,(a,c)=>{this.putSphere(c,a)})}putSphere(a,b){let {center:c,radius:d}=b;!b||isNaN(d)||
isNaN(c.x)?console.warn("Invalid sphere",b):(c._roundedX=1E-8*Math.round(c.x/1E-8),c._roundedY=1E-8*Math.round(c.y/1E-8),c._roundedZ=1E-8*Math.round(c.z/1E-8),this._putSphere(a,b))}_putSphere(a,b){var {center:c}=b,{root:d}=this;let {_roundedX:g,_roundedY:e,_roundedZ:f}=c;if(a in this.keysToLeaves)return this._updateSphere(a,b);if(d)if(d.isLeaf){c=this.root;let {dataX:p,dataY:h,dataZ:n}=d;if(p===g&&h===e&&n===f)this._insertIntoOctant(a,b,d);else{let l=new z;d=l.cx=Math.round((p+g)/2);let k=l.cy=Math.round((h+
e)/2),m=l.cz=Math.round((n+f)/2);l.cr=Math.ceil(Math.max(Math.abs(d-p),Math.abs(k-h),Math.abs(m-n))+1E-5);this.root=l;c.forEachLeafSphere((a,b)=>this._insertIntoOctant(b,a,l));this._insertIntoOctant(a,b,l)}}else this._expandToCoverPoint(g,e,f),this._insertIntoOctant(a,b,this.root);else c=new z,c.isLeaf=!0,c.addSphereData(a,b),this.root=c,this.keysToLeaves[a]=c}_expandToCoverPoint(a,b,c){for(;!this.root.containsPoint(a,b,c);){let d=this.root,{cx:g,cy:e,cz:f,cr:l}=d,h=new z;h.maxRadius=d.maxRadius;
h.sphereCount=d.sphereCount;h.leafCount=d.leafCount;h.cx=g+l*(a<g?-1:1);h.cy=e+l*(b<e?-1:1);h.cz=f+l*(c<f?-1:1);h.cr=2*l;let k=h.getSubOctantIndexForPoint(g,e,f);d.parent=h;d.index=k;h[k]=d;this.root=h}}_insertIntoOctant(a,b,c){let {center:d,radius:g}=b,{_roundedX:e,_roundedY:f,_roundedZ:l}=d;if(c.isLeaf){let {dataX:d,dataY:p,dataZ:n}=c;if(e===d&&f===p&&l===n){c.addSphereData(a,b);for(b=c.parent;b;b=b.parent)g>b.maxRadius&&(b.maxRadius=g);this.keysToLeaves[a]=c}else{var h=Ta(c);c.parent[c.index]=
h;h.addOctantForPoint(c,d,p,n);this._insertIntoOctant(a,b,h)}}else{c.sphereCount++;h=c.getSubOctantIndexForPoint(e,f,l);if(h=c[h])return this._insertIntoOctant(a,b,h);h=new z;h.isLeaf=!0;c.addOctantForPoint(h,e,f,l);h.addSphereData(a,b);for(c=h.parent;c;c=c.parent)g>c.maxRadius&&(c.maxRadius=g),c.leafCount++;this.keysToLeaves[a]=h}}removeSphere(a){var b=this.keysToLeaves[a];if(b){for(var c=b.parent;c;)c.sphereCount--,c=c.parent;if(1<b.sphereCount)b.removeSphereData(a),b.updateMaxRadii();else{c=b;
do{var d=c.parent;(b=d)&&(d[c.index]=null);c=c.parent}while(c&&0===c.sphereCount);if(!b){this.root=null;return}d=null;for(c=b;c;)c.leafCount--,1===c.leafCount&&(d=c),c=c.parent;d?(c=this._findSingleLeaf(d),(b=d.parent)?(b.addOctantForPoint(c,c.cx,c.cy,c.cz),b.updateMaxRadii()):this.root=c):b.updateMaxRadii()}delete this.keysToLeaves[a]}}_updateSphere(a,b){let c=this.keysToLeaves[a],{_roundedX:d,_roundedY:g,_roundedZ:e}=b.center;if(c.containsPoint(d,g,e)){let f=d!==c.dataX||g!==c.dataY||e!==c.dataZ;
1<c.sphereCount&&f?(c.removeSphereData(a),c.updateMaxRadii(),this._insertIntoOctant(a,b,c)):(f&&(c.dataX=d,c.dataY=g,c.dataZ=e),b.radius!==c.maxRadius&&c.updateMaxRadii())}else this.removeSphere(a),this._putSphere(a,b)}_findSingleLeaf(a){function b(a){a.isLeaf&&(d=a)}function c(a){d=null;this.walkBranch(a,b);return d}let d;this._findSingleLeaf=c;return c.call(this,a)}walkTree(a){this.root&&this.walkBranch(this.root,a)}walkBranch(a,b){if(!1!==b(a)&&!a.isLeaf)for(let c=0;8>c;c++)null!==a[c]&&this.walkBranch(a[c],
b)}forEachSphereOnRay(a,b,c){return this._forEachMatchingSphere(a.intersectsSphere.bind(a),b,c)}forEachIntersectingSphere(a,b,c){return this._forEachMatchingSphere(a.intersectsSphere.bind(a),b,c)}_forEachMatchingSphere(a,b,c){function d(d,e){a(d)&&b.call(c,d,e)}this.walkTree(b=>{if(b.isLeaf)b.forEachLeafSphere(d);else if(K.center.set(b.cx,b.cy,b.cz),K.radius=b.cr*Ra+b.maxRadius,!a(K))return!1;return!0})}}class z{containsPoint(a,b,c){let {cx:d,cy:e,cz:f,cr:n}=this;return a>=d-n&&a<d+n&&b>=e-n&&b<e+
n&&c>=f-n&&c<f+n}getSubOctantIndexForPoint(a,b,c){return(c<this.cz?0:4)+(b<this.cy?0:2)+(a<this.cx?0:1)}addOctantForPoint(a,b,c,d){let e=this.getSubOctantIndexForPoint(b,c,d),f=this.cr/2;a.parent=this;a.index=e;a.cx=this.cx+f*(b<this.cx?-1:1);a.cy=this.cy+f*(c<this.cy?-1:1);a.cz=this.cz+f*(d<this.cz?-1:1);a.cr=f;return this[e]=a}findMaxSphereRadius(){let a=0;if(this.isLeaf){var b=this.data;if(1<this.sphereCount)for(let c in b){let d=b[c].radius;d>a&&(a=d)}else a=b.radius}else for(b=0;8>b;b++)null!==
this[b]&&this[b].maxRadius>a&&(a=this[b].maxRadius);return a}updateMaxRadii(){let a=this.findMaxSphereRadius();if(a>this.maxRadius){let b=this;for(;b;)a>b.maxRadius&&(b.maxRadius=a),b=b.parent}else a<this.maxRadius&&(this.maxRadius=a,this.parent&&this.parent.updateMaxRadii())}addSphereData(a,b){var c=this.sphereCount++;if(0===c){this.leafCount=1;this.data=b;this.dataKey=a;let {_roundedX:c,_roundedY:e,_roundedZ:f}=b.center;this.dataX=c;this.dataY=e;this.dataZ=f}else if(1===c){c=this.data;let d=this.data=
Object.create(null);d[this.dataKey]=c;d[a]=b;this.dataKey=null}else 1<c&&(this.data[a]=b);b.radius>this.maxRadius&&(this.maxRadius=b.radius)}removeSphereData(a){let b=this.data;if(b){let c=this.sphereCount--;if(2<c)delete b[a];else if(2===c)for(let c in b){if(c!==a){this.dataKey=c;this.data=b[c];break}}else this.data=null}}forEachLeafSphere(a,b){let c=this.data;if(c)if(1<this.sphereCount)for(let d in c)a.call(b,c[d],d);else a.call(b,c,this.dataKey)}}Pa(z.prototype,{parent:null,index:-1,cx:0,cy:0,
cz:0,cr:0,0:null,1:null,2:null,3:null,4:null,5:null,6:null,7:null,isLeaf:!1,data:null,dataKey:null,dataX:0,dataY:0,dataZ:0,sphereCount:0,leafCount:0,maxRadius:0});let Ta=function(){const a="parent index cx cy cz cr sphereCount leafCount maxRadius".split(" ");return function(b){const c=new z;for(let d=a.length;d--;)c[a[d]]=b[a[d]];return c}}(),{assign:C}=k.utils,L=new e.Vector2,v=new e.Vector3,ra=new e.Raycaster;class E extends k.WorldBaseFacade{constructor(a){super(a);this._object3DFacadesById=Object.create(null);
this._onBgClick=this._onBgClick.bind(this)}afterUpdate(){let {width:a,height:b,antialias:c,backgroundColor:d,contextAttributes:g,_element:f}=this;var n=this._threeRenderer,l=this.rendererClass||e.WebGLRenderer;n&&n instanceof l||(n&&n.dispose(),g=C({alpha:!0,antialias:c},g),(n=f.getContext("webgl2",g)||void 0)||console.info("webgl2 init failed, trying webgl"),n=this._threeRenderer=new l(C({canvas:f,context:n},g)));l=this.shadows;n.shadowMap.enabled=!!l;l&&"object"===typeof l&&C(n.shadowMap,l);d!==
this._bgColor&&(n.setClearColor(new e.Color(d||0),null!=d?1:0),this._bgColor=d);n.outputEncoding=this.outputEncoding||e.LinearEncoding;n.toneMapping=this.toneMapping||e.NoToneMapping;this._updateDrawingBufferSize(a,b,this.pixelRatio||window.devicePixelRatio||1);super.afterUpdate()}describeChildren(){return[this._getCameraDef(),this._getSceneDef()]}_getCameraDef(){let {camera:a}=this;return C({key:"camera",facade:ha,aspect:this.width/this.height},a)}_getSceneDef(){return{key:"scene",facade:qa,lights:this.lights,
objects:this.objects,fog:this.fog,background:this.background,environment:this.environment,onClick:this.onBackgroundClick?this._onBgClick:null}}_updateDrawingBufferSize(a,b,c){let d=this._threeRenderer;d.getSize(L);L.width===a&&L.height===b&&d.getPixelRatio()===c||d.setDrawingBufferSize(a,b,c)}doRender(){function a(a,e){a.call(this._object3DFacadesById[e],d,b,c)}let b=this.getChildByKey("scene").threeObject,c=this.getChildByKey("camera").threeObject,d=this._threeRenderer;var e=this.eventRegistry;e.forEachListenerOfType("beforerender",
a,this);d.render(b,c);e.forEachListenerOfType("afterrender",a,this);if(e=this.onStatsUpdate){let {memory:a,render:b}=d.info,c={"WebGL Draw Calls":b.calls,"WebGL Geometries":a.geometries,"WebGL Textures":a.textures,"WebGL Triangles":b.triangles};b.points&&(c["WebGL Points"]=b.points);b.lines&&(c["WebGL Lines"]=b.lines);e(c)}}getFacadeUserSpaceXYZ(a){a=a.threeObject.matrixWorld.elements;return this.projectWorldPosition(a[12],a[13],a[14])}projectWorldPosition(a,b,c){v.set(a,b,c);a=this.getChildByKey("camera");
a.updateMatrices();a=a.threeObject;v.applyMatrix4(a.matrixWorldInverse);b=v.length()*(0<v.z?-1:1);v.applyMatrix4(a.projectionMatrix);return new e.Vector3((v.x+1)*this.width/2,(1-v.y)*this.height/2,b)}_normalizePointerEvent(a){if(!a.ray){var b=a;if(a.touches){var c=/^touch(end|cancel)$/.test(a.type)?a.changedTouches:a.touches;1===c.length&&(b=c[0])}var d=a.target.getBoundingClientRect();c=((b.clientX||0)-(d.left||0))/(d.width||this.width)*2-1;b=((b.clientY||0)-(d.top||0))/(d.height||this.height)*-2+
1;d=this.getChildByKey("camera");d.updateMatrices();a.ray=d.getRayAtProjectedCoords(c,b)}super._normalizePointerEvent(a)}getFacadesAtEvent(a,b){return a.ray?this.getFacadesOnRay(a.ray,b):null}getFacadesOnRay(a,b){let c=this._updateOctree(),d=null;c&&(ra.ray=a,c.forEachSphereOnRay(a,(a,c)=>{(a=(c=(a=this._object3DFacadesById)&&a[c])&&(!b||b(c))&&c.raycast&&c.raycast(ra))&&a[0]&&(a[0].facade=c,(d||(d=[])).push(a[0]))}));return d}_updateOctree(){let a=this._boundingSphereOctree;var b=this._octreeChangeset;
if(b){a||(a=this._boundingSphereOctree=new Sa);let {remove:c,put:d}=b;if(c)for(let b in c)a.removeSphere(b);if(d)for(let e in d)b=this._object3DFacadesById[e],!b||b.isDestroying||c&&c[e]||((b=b.getBoundingSphere&&b.getBoundingSphere())?a.putSphere(e,b):a.removeSphere(e));this._octreeChangeset=null}return a}_queueForOctreeChange(a,b){let c=this._octreeChangeset||(this._octreeChangeset={});(c[a]||(c[a]=Object.create(null)))[b.$facadeId]=b}_onBgClick(a){if(a.target===a.currentTarget)this.onBackgroundClick(a)}destructor(){super.destructor();
this._threeRenderer.dispose()}}E.prototype._notifyWorldHandlers=C(Object.create(k.WorldBaseFacade.prototype._notifyWorldHandlers),{getCameraPosition(a,b){b.setFromMatrixPosition(this.getChildByKey("camera").threeObject.matrixWorld)},getCameraFacade(a,b){b.callback(this.getChildByKey("camera"))},getSceneFacade(a,b){b.callback(this.getChildByKey("scene"))},projectWorldPosition(a,b){a=b.worldPosition;b.callback(this.projectWorldPosition(a.x,a.y,a.z))},object3DAdded(a){this._object3DFacadesById[a.$facadeId]=
a;this._queueForOctreeChange("put",a)},object3DBoundsChanged(a){this._queueForOctreeChange("put",a)},object3DRemoved(a){delete this._object3DFacadesById[a.$facadeId];this._queueForOctreeChange("remove",a)},rayPointerMotion(a,b){let c=new MouseEvent("mousemove");c.isRayEvent=!0;c.ray=b;c.eventSource=a;this._onPointerMotionEvent(c)},rayPointerAction(a,b){let c=new ("wheel"===b.type?WheelEvent:MouseEvent)(b.type,b);c.isRayEvent=!0;c.ray=b.ray;c.eventSource=a;this._onPointerActionEvent(c)}});let Ua="onMouseOver onMouseOut onMouseMove onMouseDown onMouseUp onClick onDoubleClick".split(" ");
class sa extends q{constructor(a){let b=new e.Object3D;b.isRenderable=!1;b.$troikaVisible=b.visible;Object.defineProperty(b,"visible",Va);super(a,b);this.notifyWorld("instanceableAdded")}setInstanceUniform(a,b){let c=this._instanceUniforms||(this._instanceUniforms=Object.create(null));if(c[a]!==b){let d=this.instancedThreeObject;!d||a in c||(d._instanceUniformNames||(d._instanceUniformNames=new Set)).add(a);c[a]=b;this.notifyWorld("instanceableUniformChanged",a)}}afterUpdate(){let a=this.instancedThreeObject;
if(a!==this._instancedObj){if(a&&this._instanceUniforms){let b=a._instanceUniformNames||(a._instanceUniformNames=new Set);for(let a in this._instanceUniforms)b.add(a)}this._instancedObj=a;this.notifyWorld("instanceableChanged");this._boundsChanged=!0}super.afterUpdate()}updateMatrices(){let a=this._worldMatrixVersion;super.updateMatrices();this._worldMatrixVersion!==a&&this.threeObject.$troikaVisible&&this.notifyWorld("instanceableMatrixChanged")}destructor(){this.notifyWorld("instanceableRemoved");
super.destructor()}getGeometry(){let a=this.instancedThreeObject;return a&&a.geometry}raycast(a){let {instancedThreeObject:b,threeObject:c}=this;if(b&&c){let d=b.matrixWorld;b.matrixWorld=c.matrixWorld;a=this._raycastObject(b,a);b.matrixWorld=d;return a}return null}}let Va={set(a){a!==this.$troikaVisible&&(this.$troikaVisible=a,this.$facade.notifyWorld("instanceableChanged"))},get(){return this.$troikaVisible}};k.utils.assign(sa.prototype,{_lastInstancedMatrixVersion:-1,_instancedThreeObject:null});
let M=new e.BufferGeometry,Wa=new e.MeshBasicMaterial,N={basic:e.MeshBasicMaterial,depth:e.MeshDepthMaterial,distance:e.MeshDistanceMaterial,lambert:e.MeshLambertMaterial,matcap:e.MeshMatcapMaterial,normal:e.MeshNormalMaterial,phong:e.MeshPhongMaterial,physical:e.MeshPhysicalMaterial,standard:e.MeshStandardMaterial,toon:e.MeshToonMaterial};class w extends q{constructor(a){super(a);this.material="standard";this.autoDisposeMaterial=this.autoDisposeGeometry=!1;this._dirtyMtlProps=null}initThreeObject(){return new e.Mesh(M,
Wa)}afterUpdate(){let {geometry:a,material:b,threeObject:c}=this;(a||M)!==c.geometry&&(this.autoDisposeGeometry&&c.geometry.dispose(),c.geometry=a||M);b!==this._lastMtl&&(this._lastMtl=b,"string"===typeof b?b=new (N[b]||e.MeshStandardMaterial):b&&b.isMaterial||(b="function"===typeof b?new b:new e.MeshStandardMaterial),c.material!==b&&(this.autoDisposeMaterial&&c.material.dispose(),c.material=b));let d=this._dirtyMtlProps;d&&(c.material.setValues(d),this._dirtyMtlProps=null);super.afterUpdate()}destructor(){this.autoDisposeGeometry&&
this.threeObject.geometry.dispose();this.autoDisposeMaterial&&this.threeObject.material.dispose();super.destructor()}}let Xa={type:1,id:1,uuid:1,version:1};Object.keys(N).forEach(a=>{a=new N[a];for(let b in a)a.hasOwnProperty(b)&&!Xa.hasOwnProperty(b)&&Object.defineProperty(w.prototype,`material.${b}`,{enumerable:!0,configurable:!0,get(){let a=this._dirtyMtlProps;return a&&b in a?a[b]:this.threeObject.material[b]},set(a){(this._dirtyMtlProps||(this._dirtyMtlProps=Object.create(null)))[b]=a}})});let ta=
k.utils.memoize(()=>new e.BoxBufferGeometry(1,1,1,1,1));class Ya extends w{get geometry(){return ta()}set width(a){this.scaleX=a}get width(){return this.scaleX}set height(a){this.scaleY=a}get height(){return this.scaleY}set depth(a){this.scaleZ=a}get depth(){return this.scaleZ}}let ua=Object.create(null,[["low",32],["medium",64],["high",128]].reduce((a,[b,c])=>{a[b]={get:k.utils.memoize(()=>(new e.CircleBufferGeometry(1,c)).rotateX(-Math.PI/2))};return a},{}));class Za extends w{constructor(a){super(a);
this["material.side"]=this["material.shadowSide"]=e.DoubleSide}get geometry(){return ua[this.detail]||ua.medium}set radius(a){this.scaleX=this.scaleZ=a}get radius(){return this.scaleX}}class $a extends w{get geometry(){return ta()}set size(a){this.scale=a}get size(){return this.scale}}let ab=k.utils.memoize(()=>(new e.PlaneBufferGeometry(1,1,1,1)).rotateX(-Math.PI/2));class bb extends w{constructor(a){super(a);this["material.side"]=this["material.shadowSide"]=e.DoubleSide}get geometry(){return ab()}set width(a){this.scaleX=
a}get width(){return this.scaleX}set depth(a){this.scaleZ=a}get depth(){return this.scaleZ}}let va=Object.create(null,[["low",16,12],["medium",32,24],["high",64,48]].reduce((a,[b,c,d])=>{a[b]={get:k.utils.memoize(()=>new e.SphereBufferGeometry(1,c,d))};return a},{}));class cb extends w{get geometry(){return va[this.detail]||va.medium}set radius(a){this.scale=a}get radius(){return this.scale}}class F extends k.ReactCanvasBase{constructor(a){super(a);this._onCanvasRef=a=>{let b=this.context.onCanvasRef;
b&&b(a);(b=this.props.onCanvasRef)&&b(a)}}render(){let {props:a,context:b}=this;return da["default"].createElement(k.ReactCanvasBase,k.utils.assign({},a,{onCanvasRef:this._onCanvasRef,canvasStyle:a.canvasStyle||b.canvasStyle,worldFacade:a.worldFacade||b.worldFacade||E,worldProps:k.utils.assign({antialias:a.antialias,rendererClass:a.rendererClass,backgroundColor:a.backgroundColor,background:a.background,environment:a.environment,outputEncoding:a.outputEncoding,toneMapping:a.toneMapping,shadows:a.shadows,
camera:a.camera,lights:a.lights,objects:a.objects,fog:a.fog,onBackgroundClick:a.onBackgroundClick},b.worldProps,a.worldProps)}),a.children)}}F.displayName="Canvas3D";F.propTypes=k.utils.assignIf({backgroundColor:m["default"].any,background:m["default"].any,environment:m["default"].any,outputEncoding:m["default"].number,toneMapping:m["default"].number,lights:m["default"].array,camera:m["default"].object,fog:m["default"].object,objects:m["default"].oneOfType([m["default"].array,m["default"].object]).isRequired,
antialias:m["default"].bool,onBackgroundClick:m["default"].func,rendererClass:m["default"].func},k.ReactCanvasBase.commonPropTypes);F.contextType=da["default"].createContext({worldFacade:E,worldProps:{},onCanvasRef:null,canvasStyle:null});Object.defineProperty(f,"Facade",{enumerable:!0,get:function(){return k.Facade}});Object.defineProperty(f,"ListFacade",{enumerable:!0,get:function(){return k.ListFacade}});Object.defineProperty(f,"ParentFacade",{enumerable:!0,get:function(){return k.ParentFacade}});
Object.defineProperty(f,"createDerivedMaterial",{enumerable:!0,get:function(){return u.createDerivedMaterial}});f.AmbientLight3DFacade=ja;f.BoxFacade=Ya;f.Canvas3D=F;f.CircleFacade=Za;f.CubeFacade=$a;f.DirectionalLight3DFacade=ka;f.Group3DFacade=ia;f.HemisphereLight3DFacade=na;f.HtmlOverlay3DFacade=Ja;f.Instanceable3DFacade=sa;f.InstancingManager=J;f.MeshFacade=w;f.Object3DFacade=q;f.OrthographicCamera3DFacade=G;f.PerspectiveCamera3DFacade=ha;f.PlaneFacade=bb;f.PointLight3DFacade=ma;f.RectAreaLight3DFacade=
Ka;f.Scene3DFacade=qa;f.SphereFacade=cb;f.SpotLight3DFacade=la;f.World3DFacade=E;f.makeWorldTextureProvider=function(a){return class extends a{constructor(a){let b=new e.CanvasTexture;super(a,b);this.worldTexture=b;let d=this._refireAsInnerEvent.bind(this);Ua.forEach(a=>{function b(a){d(a);c&&c.call(this,a)}let c;this[a]=b;Object.defineProperty(this,a,{set(a){c=a},get(){return b}})})}afterUpdate(){var a=this._worldFacade;let c=this.textureWorld;a&&c&&a instanceof c.facade||(a&&(a.onAfterRender=null,
a.destructor()),c&&(this.worldTexture.dispose(),a=document.createElement("canvas"),a.width=a.height=2,this.worldTexture.image=a,a=this._worldFacade=new c.facade(a),a.onAfterRender=()=>{this.worldTexture.needsUpdate=!0;this.requestRender()}));a&&(a.renderingScheduler=this._getOuterWorld().renderingScheduler,k.utils.assign(a,c),a.afterUpdate());super.afterUpdate()}_refireAsInnerEvent(a){var b=this._worldFacade;if(b){var d=a.intersection&&a.intersection.uv;let c=d?Math.round(d.x*b.width):-1;b=d?Math.round((1-
d.y)*b.height):-1;a=a.nativeEvent||a;d=document.createEvent("MouseEvents");d.initMouseEvent(a.type,!0,!0,window,a.detail,c,b,c,b,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null);this.worldTexture.image.dispatchEvent(d)}}_getOuterWorld(){let a=this;for(;a&&!a.isWorld;)a=a.parent;return a}destructor(){let a=this._worldFacade;a&&(a.onAfterRender=null,a.destructor());this.worldTexture.dispose();super.destructor()}}};Object.defineProperty(f,"__esModule",{value:!0})})
